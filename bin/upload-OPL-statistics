#!/usr/bin/perl

##############################################################################
# WeBWorK Online Homework Delivery System
# Copyright Â© 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/
# $CVSHeader: webwork2/bin/wwdb,v 1.13 2006/01/25 23:13:45 sh002i Exp $
#
# This program is free software; you can redistribute it and/or modify it under
# the terms of either: (a) the GNU General Public License as published by the
# Free Software Foundation; either version 2, or (at your option) any later
# version, or (b) the "Artistic License" which comes with this package.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE. See either the GNU General Public License or the
# Artistic License for more details.
##############################################################################

# This script dumps the local OPL statistics table and uploads it.  

BEGIN{ die('You need to set the WEBWORK_ROOT environment variable.\n')
	   unless($ENV{WEBWORK_ROOT});}
use lib "$ENV{WEBWORK_ROOT}/lib";

use WeBWorK::CourseEnvironment;

use Net::Domain;
use String::ShellQuote;

my $ce = new WeBWorK::CourseEnvironment({
					 webwork_dir => $ENV{WEBWORK_ROOT},});

my ($dbi,$dbtype,$db,$host) = split(':',$ce->{database_dsn});

$host = 'localhost' unless $host;

my $dbuser = $ce->{database_username};
my $dbpass = $ce->{database_password};

my $domainname = Net::Domain::domainname;
my $time = time();
my $output_file = "$domainname-$time-opl.sql";

print "Dumping local OPL statistics\n";

$dbuser = shell_quote($dbuser);
$dbpass = shell_quote($dbpass);
$db = shell_quote($db);

`mysqldump --host=$host --user=$dbuser --password=$dbpass $db OPL_local_statistics > $output_file`;

print "Database File Created\n";

my $desc_file = "$domainname-$time-desc.txt";

open(my $fh, ">", $desc_file)
  or die "Couldn't open file for saving description.";

print "\nWe would appreciate it if you could provide \nsome basic information to help us \nkeep track of the data we receive.\n\n";

print $fh "File:\n$output_file\n";

print "What university is this data for?\n";

print $fh "University:\n";
my $input = <STDIN>;
print $fh $input;

print "What department is this data for?\n";

print $fh "Department:\n";
$input = <STDIN>;
print $fh $input;

print "What is your name?\n";

print $fh "Name:\n";
$input = <STDIN>;
print $fh $input;

print "What is your email address?\n";

print $fh "Email:\n";
$input = <STDIN>;
print $fh $input;

print "Approximately what years does this data span?\n";

print $fh "Years:\n";
$input = <STDIN>;
print $fh $input;

print "Approximately how many classes are included?\n";

print $fh "Number of Classes:\n";
$input = <STDIN>;
print $fh $input;

print "Anything else?\n";

print $fh "Other:\n";
$input = <STDIN>;
print $fh $input;

close($fh);

my $tar_file = "$domainname-$time-data.tar.gz";

print "Zipping files\n";
`tar -czf $tar_file $output_file $desc_file`;

print "Uploading file\n";
    
`echo "put $tar_file" | sftp -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -oPort=57281 wwdata\@52.27.200.59`;


1;
